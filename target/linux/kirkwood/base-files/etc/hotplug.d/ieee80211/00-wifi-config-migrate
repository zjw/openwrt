#!/bin/sh

# With kernel 4.7, PCIe has a range property, so the unit name should contain
# an address (see https://github.com/torvalds/linux/commit/eb13cf8345e9).
# Also, the mbus node has a ranges property (see
# https://github.com/torvalds/linux/commit/5d7fd6563348).  Also, the
# pcie-controller device was renamed to pcie in Linux kernel 4.14 (see
# https://github.com/torvalds/linux/commit/28fbb9c539e2).  This script migrates
# the path in the UCI configuration from the old name to the new name. This has
# to be done before the 10-wifi-detect script from mac80211 is executed because
# that script would add the devices again under the new path name.

. /lib/functions.sh

PATH_CHANGED=0

rename_wifi_path() {
	local path_old=$(uci get wireless.${1}.path)
	local path_new=$(echo ${path_old} | sed "${2}")

	if [ -e "/sys/devices/platform/${path_new}" ] && [ ${path_old} != ${path_new} ]
	then 
		uci set wireless.${1}.path=${path_new}
		PATH_CHANGED=1
	fi
}

rename_wifi_path_list() {
	# migration from kernel 4.7 to 4.14
	rename_wifi_path $1 "s%mbus/mbus:pcie-controller%mbus@f1000000/mbus@f1000000:pcie@82000000%"
}

[ "${ACTION}" = "add" ] && {
	[ ! -e /etc/config/wireless ] && return

	config_load wireless
	config_foreach rename_wifi_path_list wifi-device

	[ "$PATH_CHANGED" = "1" ] && uci commit wireless
}
